<!DOCTYPE html>
<html>

<head>
  <title>Log In</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@magic-ext/oauth/dist/extension.js"></script>
  <script>
    const MAGIC_API_KEY = "pk_test_E90FA292AE61C345";

    const magic = new Magic(MAGIC_API_KEY, {
      extensions: [new MagicOAuthExtension()],
    });

    const urlParams = new URLSearchParams(window.location.search);

    const render = async () => {
      let html = ``;

      if (urlParams.get('provider')) {
        try {
          const result = await magic.oauth.getRedirectResult();
          const profile = JSON.stringify(result.oauth.userInfo, undefined, 2);

          html = `
                <h1>It Worked! ðŸŽ‰</h1>
                <h2>Your User Profile:</h2>
                <pre><code class="json tomorrow">${profile}</code></pre>
              `;
        } catch {
          window.location.href = window.location.origin;
        }
      } else {
        html = `
              <h2>Please sign up or log in</h2>
              <form onsubmit="handleLogin(event)">
                <button id="btn-send" class="google" type="submit">
                  <img src="sign-in-with-google.svg" />
                </button>
              </form>
            `;
      }

      document.getElementById("app").innerHTML = html;
      document.querySelectorAll("pre code").forEach((block) => {
        hljs.highlightBlock(block);
      });
    };

    /**
     * Starts the OAuth 2.0 login flow.
     */
    const handleLogin = async (e) => {
      e.preventDefault();

      // Render a button "pending" state.
      const btnSend = document.getElementById("btn-send");
      btnSend.disabled = true;
      btnSend.innerText = "Logging in...";

      // Start the Google OAuth 2.0 flow!
      const didToken = await magic.oauth.loginWithRedirect({
        provider: "google",
        redirectURI: `${window.location.origin}/login/`
      });
    };
  </script>
</head>

<body onload="render()">
  <div id="app">Loading...</div>
</body>

</html>